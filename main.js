const dictionary = {
    '김': {
        start: ['기분 좋은 웃음이 당신의 하루를 환하게 열어주고,', '기쁨의 노래가 마음속에서 솔솔 피어오르는 오늘 되길,', '기대하는 마음으로 시작하는 오늘이 당신께 큰 선물이 되어,'],
        mid: ['기다려온 소망의 일들이 하나씩 하나씩 예쁘게 이루어지며,', '기도하는 마음마다 따뜻한 평화가 가득히 채워지는 것을 보고,', '기쁨이 샘물처럼 솟아나 당신의 주변까지 행복하게 만들어서,'],
        end: ['기적 같은 행복이 당신의 모든 날에 가득하길 축복합니다.', '기분 좋은 일들만 가득한 멋진 인생 되시길 소망해요.', '기다림 끝에 맺힌 소중한 열매들이 당신의 삶을 채우길 빌어요.']
    },
    '이': {
        start: ['이토록 따뜻한 사랑이 오늘 당신을 포근히 덮어주고,', '이슬처럼 맑고 깨끗한 마음으로 기분 좋게 하루를 시작하며,', '이 세상에서 가장 소중한 당신의 이름을 주님이 꼭 기억하시니,'],
        mid: ['이제는 걱정보다 소망을 더 많이 품고 씩씩하게 오늘을 걷고,', '이전보다 더 크신 주의 은혜가 당신의 발걸음을 가볍게 하며,', '이름만 불러도 힘이 되는 주님의 위로가 당신의 마음을 만져주어,'],
        end: ['이름처럼 아름다운 삶을 마음껏 펼쳐나가시길 축복하고 응원해요.', '이전보다 더 행복하고 웃음꽃 피는 날들이 평생 가득하세요.', '이토록 복된 당신의 앞날에 주님의 평강이 늘 함께하시길 원합니다.']
    },
    '박': {
        start: ['밝은 햇살이 당신의 창가를 제일 먼저 찾아와 인사를 건네듯,', '박수 소리처럼 기분 좋은 일들이 당신의 삶에 끊임없이 넘쳐나고,', '밝고 맑은 마음으로 세상을 아름답게 바라보는 눈이 활짝 열려,'],
        mid: ['밝게 빛나는 별처럼 당신의 존재가 주변을 환하게 비추는 빛이 되고,', '박자 맞춰 흐르는 노래처럼 삶의 모든 순간이 즐거움으로 가득하며,', '박애의 따뜻한 마음으로 주변을 돌보는 주님의 귀한 손길이 되어,'],
        end: ['밝아오는 내일이 오늘보다 더 예쁘게 빛나길 간절히 축복합니다.', '박수받기에 충분한 당신의 귀한 삶을 주님이 늘 지켜주실 거예요.', '밝고 환한 미소가 당신의 얼굴에서 영원히 떠나지 않길 기도해요.']
    },
    '최': {
        start: ['최고의 선물인 오늘 하루를 주님과 함께 기쁘게 시작하고,', '처음 가졌던 그 순수한 마음을 잃지 않고 소중히 간직하며,', '최초의 사랑, 그 설렘과 감격을 날마다 새롭게 회복하여 나아가서,'],
        mid: ['최선을 다해 걷는 당신의 모든 걸음을 주님이 든든히 붙드시고,', '최고로 행복한 웃음이 당신의 얼굴에서 햇살처럼 늘 피어나며,', '최상의 가치인 주님의 말씀을 등불 삼아 흔들림 없이 걷게 되어,'],
        end: ['최후의 순간까지 주님과 손잡고 걷는 가장 복된 인생 되소서.', '최고로 소중한 당신의 꿈들이 주 안에서 멋지게 이루어지길 축복합니다.', '최상의 복을 누리는 주님의 자녀로 세상에서 승리하며 사시길 빌어요.']
    },
    '정': {
        start: ['정말 소중한 당신에게 하늘의 평안이 이 아침 가득 전해지고,', '정성 가득한 당신의 마음을 주님이 기쁘게 받아주시는 은혜가 있고,', '정다운 사람들과 함께 웃으며 행복한 추억을 만들어가는 오늘 되길,'],
        mid: ['정직하고 고운 성품이 당신의 삶을 보석보다 더 빛나게 만들고,', '정말로 좋은 일들만 당신의 앞길에 예비되어 있음을 믿고 걸으며,', '정든 주의 품 안에서 세상이 줄 수 없는 참된 평안을 가득 누려서,'],
        end: ['정말 행복한 당신의 모든 날을 주님의 이름으로 축복하고 응원해요.', '정오의 햇살보다 밝게 빛나는 주의 영광이 당신의 평생에 함께하시길.', '정성껏 빚으신 당신의 인생이 주님께 가장 큰 기쁨이 될 것입니다.']
    },
    '유': {
        start: ['유난히 따뜻한 사랑이 당신의 발걸음을 졸졸 따라다니는 축복이 있고,', '유일하게 빛나는 당신의 가치를 주님이 보석처럼 소중히 여기시며,', '유연하고 부드러운 마음으로 세상을 품는 넉넉함이 당신께 생겨나서,'],
        mid: ['유리처럼 투명하고 맑은 주님의 평강이 당신의 모든 생각을 덮어주고,', '유익하고 복된 삶으로 많은 이들에게 주님의 사랑을 전하는 통로가 되어,', '유달리 행복한 웃음소리가 당신의 가정과 일터에서 끊이지 않게 되어,'],
        end: ['유리바다처럼 평온한 주의 은혜가 당신의 심령에 머물길 축복합니다.', '유달리 빛나는 주의 자녀로 세상 속에서 날마다 승리하시길 기도해요.', '유구한 시간 속에서도 변치 않는 주님의 사랑을 평생 누리며 사소서.']
    },
    '은': {
        start: ['은은하게 퍼지는 꽃향기처럼 주님의 사랑이 당신의 삶에 스며들고,', '은혜의 선물로 주신 오늘 하루를 오직 감사함으로 기쁘게 시작하며,', '은총의 햇살이 당신이 걷는 모든 길을 따뜻하게 비추어주는 축복 속에,'],
        mid: ['은밀하게 챙겨주시는 주님의 손길을 삶의 구석구석에서 매 순간 느끼고,', '은하수보다 더 빛나는 주의 약속이 당신의 삶에서 하나씩 이루어지는 걸 보고,', '은혜 아래 사는 삶이 얼마나 행복한지 당신의 미소를 통해 세상이 알게 되어,'],
        end: ['은총의 구름 기둥이 당신의 앞길을 시원하게 인도하시길 간절히 축복해요.', '은혜로 가득 찬 당신의 인생이 주님께 향기로운 노래가 되길 원합니다.', '은혜받은 자의 당당함으로 세상의 풍파를 넉넉히 이기며 살아가소서.']
    },
    '하': {
        start: ['하늘 문을 활짝 여시고 쏟아지는 하늘의 복을 당신이 가득 받으시길,', '하나님의 형상을 닮은 당신은 이 세상에서 가장 소중하고 귀한 사람,', '하늘 가득한 주님의 영광이 당신의 앞길을 찬란하게 비추어주는 아침,'],
        mid: ['하루의 시작과 끝이 오직 감사의 고백으로 가득히 채워지는 기쁨을 누리고,', '하늘 소망 가슴에 품고 주님과 함께 예쁜 꽃길을 사뿐히 걸어가는 자 되어,', '하나님의 큰 기쁨이 되는 당신의 모든 날을 주님이 응원하시고 축복하셔서,'],
        end: ['하늘의 평화와 기쁨이 당신의 생각을 굳게 지켜주시길 간절히 축원합니다.', '하늘 소망 붙들고 주와 함께 영원히 행복한 주인공으로 살아가소서.', '하나님 보시기에 가장 아름다운 당신의 앞날을 마음 다해 축복합니다.']
    },
    '수': {
        start: ['수줍게 피어난 꽃 한 송이처럼 당신의 미소가 세상 무엇보다 참 예쁘고,', '수정처럼 맑고 깨끗한 주님의 평안이 당신의 모든 생각을 가득 채우며,', '수많은 약속의 말씀들이 당신의 삶 속에서 하나하나 예쁘게 이루어지길,'],
        mid: ['수면 위에 비친 평온한 달빛처럼 당신의 마음이 한없이 든든해지고,', '수풀 우거진 숲처럼 많은 이들에게 따뜻한 쉼을 주는 너른 마음을 가져서,', '수평선 너머의 희망을 바라보며 주님과 함께 파도를 넘어 전진하는 자 되어,'],
        end: ['수지맞은 인생처럼 주 안에서 가장 귀한 복을 날마다 누리길 축복해요.', '수정같이 맑은 생명수 강가로 당신을 인도하실 주님을 찬양합니다.', '수고한 당신의 눈물을 닦아주시는 주님의 품 안에서 늘 행복하세요.']
    },
    '빈': {
        start: ['빈틈없이 채워주시는 주님의 은혜가 당신의 평생에 가득하기를 빌며,', '빈자리마다 따뜻한 사랑으로 포근하게 감싸주시는 주님을 날마다 느끼고,', '빈 마음속에 하늘의 평안과 세상이 줄 수 없는 기쁨이 가득히 차올라서,'],
        mid: ['빈손으로 시작해도 주님이 채우시는 놀라운 풍성함을 삶에서 경험하며,', '빈틈없는 주님의 보호 아래서 어떤 어려움도 넉넉히 이겨내는 용기를 얻고,', '빈틈없이 행복한 당신의 앞날을 위해 주님이 친히 일하시는 것을 보게 되어,'],
        end: ['빈틈없는 주님의 사랑이 당신을 영원토록 든든하게 지켜주실 것입니다.', '빈 마음을 주의 사랑으로 가득 채워 이웃에게 나누어주는 복된 인생 되소서.', '빈틈없이 완벽한 주님의 계획이 당신의 삶에서 찬란하게 꽃피길 축복합니다.']
    }
};

function getJosa(char, type) {
    const code = char.charCodeAt(0);
    if (code < 44032 || code > 55203) return '';
    const hasBatchim = (code - 44032) % 28 !== 0;
    const josaMap = {
        '이/가': hasBatchim ? '이' : '가',
        '은/는': hasBatchim ? '은' : '는',
        '을/를': hasBatchim ? '을' : '를',
        '으로/로': hasBatchim ? '으로' : '로',
        '이라는/라는': hasBatchim ? '이라는' : '라는',
        '와/과': hasBatchim ? '과' : '와'
    };
    return josaMap[type] || '';
}

const fallbacks = {
    start: (char) => `${char}${getJosa(char, '이라는/라는')} 소중한 이름 위에 주님의 축복이 가득 머물고,`,
    mid: (char) => `${char}${getJosa(char, '와/과')} 함께하시는 주님의 따뜻한 온기가 삶의 자리마다 가득하며,`,
    end: (char) => `${char}${getJosa(char, '이/가')} 걷는 모든 길에 주님의 따뜻한 동행이 있길 간절히 축복합니다.`
};

const finalBliss = [
    '주님의 이름으로 당신을 오늘 더 축복합니다.',
    '언제나 주님과 함께 걷는 가장 행복한 사람 되세요.',
    '따스한 주님의 손길이 당신의 하루를 꼭 안아주길 기도해요.',
    '하늘의 평화와 기쁨이 당신의 생각을 굳게 지켜주길 원합니다.'
];

function getRandom(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
}

const generateBtn = document.getElementById('generateBtn');
const nameInput = document.getElementById('nameInput');
const resultArea = document.getElementById('resultArea');
const cardsContainer = document.getElementById('cardsContainer');

generateBtn.addEventListener('click', () => {
    const name = nameInput.value.trim();
    if (!name) {
        alert('성함을 입력해주세요!');
        return;
    }
    generateThreeOptions(name);
});

function generateThreeOptions(name) {
    cardsContainer.innerHTML = '';
    
    // [핵심 개선] 세 카드가 서로 문구를 겹치지 않게 하기 위해 사용된 인덱스를 저장
    const globalUsedIndices = {}; 

    for (let i = 1; i <= 3; i++) {
        const poemLines = generateSinglePoem(name, globalUsedIndices);
        const card = createPoemCard(poemLines, i);
        cardsContainer.appendChild(card);
    }

    resultArea.classList.remove('hidden');
    if (window.navigator.vibrate) window.navigator.vibrate(10);

    setTimeout(() => {
        const yOffset = -50;
        const y = resultArea.getBoundingClientRect().top + window.pageYOffset + yOffset;
        window.scrollTo({top: y, behavior: 'smooth'});
    }, 150);
}

function generateSinglePoem(name, globalUsedIndices) {
    const characters = name.split('');
    const lines = [];

    characters.forEach((char, index) => {
        let position = 'mid';
        if (index === 0) position = 'start';
        else if (index === characters.length - 1) position = 'end';

        let phrase = '';
        if (dictionary[char]) {
            const options = dictionary[char][position];
            
            // 전역 사용 인덱스 추적
            const key = `${char}_${position}`;
            if (!globalUsedIndices[key]) globalUsedIndices[key] = new Set();
            
            // 아직 사용되지 않은 인덱스 필터링
            let availableIndices = options.map((_, i) => i).filter(i => !globalUsedIndices[key].has(i));
            
            // 만약 모든 옵션을 다 썼다면 다시 전체 초기화
            if (availableIndices.length === 0) {
                globalUsedIndices[key].clear();
                availableIndices = options.map((_, i) => i);
            }

            const randIdx = availableIndices[Math.floor(Math.random() * availableIndices.length)];
            globalUsedIndices[key].add(randIdx);
            phrase = options[randIdx];
        } else {
            phrase = fallbacks[position](char);
        }
        lines.push(phrase);
    });

    lines.push(getRandom(finalBliss));
    return lines;
}

function createPoemCard(lines, index) {
    const card = document.createElement('div');
    card.className = 'poem-card';
    card.style.animationDelay = `${index * 0.2}s`; // 카드 등장 애니메이션 순차적으로
    
    const tag = document.createElement('span');
    tag.className = 'card-tag';
    tag.innerText = `축복 제안 ${index}`;
    card.appendChild(tag);

    const content = document.createElement('div');
    content.className = 'poem-content';

    lines.forEach((phrase, i) => {
        const line = document.createElement('div');
        line.className = 'poem-line';
        if (i === lines.length - 1) line.classList.add('final-line');
        
        if (i === lines.length - 1) {
            line.innerText = phrase;
        } else {
            const firstChar = phrase.charAt(0);
            const restOfPhrase = phrase.substring(1);
            line.innerHTML = `<span class="first-char">${firstChar}</span>${restOfPhrase}`;
        }
        content.appendChild(line);
    });

    card.appendChild(content);

    const copyBtn = document.createElement('button');
    copyBtn.className = 'copy-btn-small';
    copyBtn.innerText = '이 축복 메시지 복사하기';
    copyBtn.onclick = (e) => {
        e.stopPropagation();
        copyToClipboard(lines.join('\n'), copyBtn);
    };
    card.appendChild(copyBtn);

    return card;
}

function copyToClipboard(text, btn) {
    navigator.clipboard.writeText(text).then(() => {
        const originalText = btn.innerText;
        btn.innerText = '✅ 복사 완료!';
        btn.classList.add('success');
        setTimeout(() => {
            btn.innerText = originalText;
            btn.classList.remove('success');
        }, 2000);
    });
}

nameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        generateBtn.click();
        nameInput.blur();
    }
});
